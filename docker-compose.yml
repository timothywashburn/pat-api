services:
  pat-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: kyrokrypt/pat-server:latest
    container_name: pat-server
    restart: unless-stopped
    environment:
      - MONGODB_URI=mongodb://root:example@mongodb:27017/?tls=true&tlsCAFile=/etc/mongodb/ca.crt&tlsCertificateKeyFile=/etc/mongodb/pat-client.pem&authSource=admin
    volumes:
      - ./certs:/etc/mongodb:ro
    depends_on:
      - mongodb

  mongodb:
    image: mongo:latest
    container_name: pat-mongodb
    restart: unless-stopped
    user: "999:999"
    command:
      - mongod
      - --tlsMode
      - requireTLS
      - --tlsCertificateKeyFile
      - /etc/mongodb/mongodb.pem
      - --tlsCAFile
      - /etc/mongodb/ca.crt
      - --tlsAllowInvalidCertificates
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./certs:/etc/mongodb:ro

volumes:
  mongodb_data:
    name: pat-mongodb-data
  mongodb_config:
    name: pat-mongodb-config